---
title: "extending ggplot"
output: html_notebook
---


install the ggpattern package 

```{r}
install.packages(c('remotes', 'gapminder'))
remotes::install_github("coolbutuseless/ggpattern")
```

## gapminder and ggpattern

```{r}
library(ggpattern)
library(tidyverse)
gapminder_ss <- read_tsv('../src/gapminder_2007.tsv.gz') %>% 
    mutate(gender = sample(c('M', 'F'), size = nrow(.), replace = T) )
gapminder_summarized <- gapminder_ss %>% 
    group_by(continent, gender) %>% 
    summarise(avg_lifespan = mean(lifeExp))

```

- I've added some data about gender to the `gapminder` dataset. use this data set to calculate the average lifespan per continent per gender. plot a bargraph with colors for each continents and patterns for each gender. 
- hint: becasue the data is averaged, you will be using `geom_col`

```{r ex_1}

ggplot(gapminder_summarized) + 
    geom_col_pattern(aes(x=continent, y=avg_lifespan, pattern = gender, 
                         fill = continent ), position = 'dodge')

```


## revisting the line graph from earlier with `ggpubr`

```{r}
knitr::include_graphics('../src/reporter_assay_plot.png')
```

Remember this plot?
use `ggpubr::ggline` to remake the line graph we made a few exercises ago. You will have to reshape the data from wide to long 

```{r ex_2}
install.packages('ggpubr')
```

```{r ex_3}

library(ggpubr)
data <- read_tsv('../src/Reporter_assay_results.tsv.gz') %>% 
    pivot_longer(cols = c(WildType, Mutant) )

ggline(data=data,x='Time', y='value', add='mean_se', color = 'name', 
       shape = 'name',ylab = 'Scientific Units (SU)' )

```

filter the data to the last time point, and make a boxplot with `ggboxplot`. Include a test for a statistically significant change in the data on the plot. 

```{r ex_4}
data_filtered <- filter(data, Time == 24)
ggboxplot(data = data_filtered, x= 'name', y='value') + 
    stat_compare_means(label = 'p.signif')
```


## gganimate

- continuing with the gapminder dataset, remake the bubble plot we made yesterday. We'll be using the full dataset this time, and have data for many years. Create an animated version of the bubble plots we made earlier to visualize changes across time. 
- customize the plots with some themes and palettes from `ggsci` or `ggthemes`

```{r}
install.packages('gapminder') # this installs the gapminder dataset into R
install.packages('gganimate')
install.packages('ggsci')
```


```{r ex_5}
library(tidyverse)
library(gapminder)
library(ggplot2)
library(gganimate)
library(ggsci)
#install.packages('gifski')
gapminder
plot <- ggplot(gapminder) + 
  geom_point(aes(x=gdpPercap, 
                 y = lifeExp, 
                 color = continent,
                 size = pop), alpha = .5) + 
  scale_size(range = c(0, 15)) + 
  guides(size = guide_legend(title = 'Population (M)'),
         color = guide_legend(title = 'Continent')) + 
    transition_reveal(year)
anim_save(filename = 'gapminder_bubble.gif',plot) 


```

## plotting with maps 

```{r}
install.packages('sf')
install.packages('ggspatial')
library(sf)
library(ggspatial)
```


```{r}
library(sf)
library(ggspatial)
```


Lets make a plot with some real data. We're gonna be working with some data about COVID-19 testing in maryland. 
'../src/MD_COVID_cases_by_zip.tsv.gz' contains the per day number of positive covid cases by zip code for about 160 days in the state of maryland. 
'../src/maryland_zipcode_to_county.tsv.gz' contains a mapping for maryland zip code to counties
'../src/maryland_counties.shp' is a shapefile for counties in maryland (`st_read`)

run this chunk to load the data 

```{r}
library(sf)
library(ggspatial)

md_covid_cases <- read_tsv('../src/MD_COVID_cases_by_zip.tsv.gz')
md_county_to_zip <- read_tsv('../src/maryland_zipcode_to_county.tsv.gz')
unzip('maryland.zip')
shp_file = list.files(recursive = T, full.names = T) %>% {.[grepl("Maryland_Physical_Boundaries_-_County_Boundaries_(Generalized).shp", . , fixed = T)]}
md_shape <- read_sf(shp_file[1])

ggplot(md_shape) + 
    geom_sf(aes(geometry = geometry))
```

Were going to take this data and make plot of covid cases per county in maryland 
As a starting point, this is the general workflow. 

- join county level data to zip level data
- aggregate data to the county level 
    - pivot from wide to long (hint: remember the negative selection syntax for pivot longer)
    - summarise zip level to county level 
- join map data(make sure the column(s) you are joining on have matches )
- use ggspatial to plot the per-county covid cases. use the `viridis`( `scale_*_viridis_c`) palette for shading

```{r ex_6}
data_pre_processed <-  md_covid_cases %>% 
    pivot_longer(cols = -c(OBJECTID, ZIP_CODE), 
                 names_to = 'date', 
                 values_to = 'n_cases') %>% 
    filter(date == '4_30_2020') %>% 
    rename(zip_code = ZIP_CODE) %>% 
    inner_join(md_county_to_zip) %>% 
    group_by(county) %>% 
    summarise(total_cases = sum(n_cases, na.rm = T))

md_shape_with_coviddata <-  md_shape %>% 
    mutate(county = tolower(county)) %>% 
    left_join(data_pre_processed) %>% 
    mutate(total_cases = replace(total_cases, is.na(total_cases), 0))


ggplot(md_shape_with_coviddata ) + 
    geom_sf(aes(geometry = geometry, fill = total_cases))

```



